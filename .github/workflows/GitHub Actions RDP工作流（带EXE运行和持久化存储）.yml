name: Windows RDP with EXE Execution and Persistent Storage

on:
  workflow_dispatch:
    inputs:
      rdp_password:
        description: 'Remote Desktop Password (min 8 chars, must include uppercase, lowercase, number, and special character)'
        required: true
        type: string
      rdp_port:
        description: 'Remote Desktop Port (default: 3389)'
        required: false
        default: '3389'
        type: string
      exe_url:
        description: 'URL of EXE file to download and run (optional)'
        required: false
        default: ''
        type: string
      storage_repo:
        description: 'GitHub repository for persistent storage (format: username/repo)'
        required: false
        default: ''
        type: string
      storage_token:
        description: 'GitHub Personal Access Token with repo scope (for storage)'
        required: false
        default: ''
        type: string

jobs:
  windows-rdp:
    runs-on: windows-2022
    timeout-minutes: 360
    
    steps:
      - name: üö®üö®üö® Important Disclaimer
        run: |
          Write-Host "============================================="
          Write-Host "‚ö†Ô∏è  IMPORTANT: FOR LEARNING PURPOSES ONLY"
          Write-Host "============================================="
          Write-Host "This workflow is provided solely for educational"
          Write-Host "and learning purposes. Users are responsible for"
          Write-Host "complying with GitHub's Terms of Service and"
          Write-Host "all applicable laws and regulations."
          Write-Host "============================================="

      - name: üìãüìã Validate Input Parameters
        run: |
          Write-Host "============================================="
          Write-Host "Validating Input Parameters"
          Write-Host "============================================="
          
          # Validate password complexity
          $rdpPassword = "${{ github.event.inputs.rdp_password }}"
          $passwordRequirements = @(
              @{ Name = "Minimum length 8 characters"; Test = { $rdpPassword.Length -ge 8 } },
              @{ Name = "At least one uppercase letter"; Test = { $rdpPassword -match '[A-Z]' } },
              @{ Name = "At least one lowercase letter"; Test = { $rdpPassword -match '[a-z]' } },
              @{ Name = "At least one number"; Test = { $rdpPassword -match '[0-9]' } },
              @{ Name = "At least one special character"; Test = { $rdpPassword -match '[^a-zA-Z0-9]' } }
          )
          
          $valid = $true
          foreach ($req in $passwordRequirements) {
              if (-not (& $req.Test)) {
                  Write-Error "‚ùå Password validation failed: $($req.Name)"
                  $valid = $false
              } else {
                  Write-Host "‚úÖ $($req.Name)"
              }
          }
          
          if (-not $valid) {
              Write-Error "‚ùå Password does not meet complexity requirements"
              exit 1
          }
          
          # Validate port number
          $rdpPort = "${{ github.event.inputs.rdp_port }}"
          if (-not ($rdpPort -match '^\d+$') -or [int]$rdpPort -lt 1 -or [int]$rdpPort -gt 65535) {
              Write-Error "‚ùå Invalid port number: $rdpPort"
              exit 1
          }
          
          Write-Host "`n‚úÖ All parameters validated successfully"

      - name: üñ•Ô∏è Configure Remote Desktop Access
        run: |
          Write-Host "============================================="
          Write-Host "Configuring Remote Desktop Access"
          Write-Host "============================================="
          
          try {
              # Set RDP password from input
              $rdpPassword = "${{ github.event.inputs.rdp_password }}"
              $env:COMPUTERNAME = $env:COMPUTERNAME.ToUpper()
              $userName = "GitHubActionsUser"
              $rdpPort = "${{ github.event.inputs.rdp_port }}"
              
              Write-Host "Creating RDP user account: $userName"
              
              # Check if user already exists
              if (-not (Get-LocalUser -Name $userName -ErrorAction SilentlyContinue)) {
                  # Create new user
                  $securePassword = ConvertTo-SecureString $rdpPassword -AsPlainText -Force
                  New-LocalUser -Name $userName -Password $securePassword -FullName "GitHub Actions User" -Description "User for RDP access (learning purposes only)"
                  
                  # Add user to Remote Desktop Users group
                  Add-LocalGroupMember -Group "Remote Desktop Users" -Member $userName
                  Write-Host "‚úÖ User $userName added to Remote Desktop Users group"
              } else {
                  Write-Host "‚ÑπÔ∏è User $userName already exists, updating password"
                  $securePassword = ConvertTo-SecureString $rdpPassword -AsPlainText -Force
                  Set-LocalUser -Name $userName -Password $securePassword
              }
              
              # Enable Remote Desktop
              Write-Host "Enabling Remote Desktop"
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
              
              # Configure RDP settings
              Write-Host "Configuring RDP security settings"
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
              
              # Configure firewall
              Write-Host "Configuring Windows Firewall for RDP"
              netsh advfirewall firewall add rule name="Allow RDP" dir=in action=allow protocol=TCP localport=$rdpPort
              
              # Get public IP address
              Write-Host "Getting public IP address"
              $publicIp = Invoke-RestMethod -Uri "http://ifconfig.me" -TimeoutSec 10
              
              Write-Host "`n============================================="
              Write-Host "‚úÖ Remote Desktop Configuration Complete"
              Write-Host "============================================="
              Write-Host "RDP Connection Details:"
              Write-Host "Computer: $publicIp`:$rdpPort"
              Write-Host "Username: $env:COMPUTERNAME\$userName"
              Write-Host "Password: [Provided password]"
              Write-Host "`n‚ö†Ô∏è  Note: This is for LEARNING PURPOSES ONLY"
              Write-Host "============================================="
              
          } catch {
              Write-Error "‚ùå RDP configuration failed: $_"
              exit 1
          }

      - name: üì• Download and Run EXE File
        if: ${{ github.event.inputs.exe_url != '' }}
        run: |
          Write-Host "============================================="
          Write-Host "Downloading and Running EXE File"
          Write-Host "============================================="
          
          try {
              $exeUrl = "${{ github.event.inputs.exe_url }}"
              $exePath = "$env:TEMP\app.exe"
              
              Write-Host "Downloading EXE from: $exeUrl"
              Invoke-WebRequest -Uri $exeUrl -OutFile $exePath -TimeoutSec 300
              
              if (Test-Path $exePath) {
                  Write-Host "‚úÖ EXE downloaded successfully"
                  Write-Host "Running EXE file..."
                  Start-Process -FilePath $exePath -NoNewWindow
                  Write-Host "‚úÖ EXE started successfully"
              } else {
                  Write-Error "‚ùå Failed to download EXE file"
              }
          } catch {
              Write-Warning "‚ö†Ô∏è EXE execution failed: $_"
          }

      - name: üíæ Initialize Persistent Storage
        if: ${{ github.event.inputs.storage_repo != '' && github.event.inputs.storage_token != '' }}
        run: |
          Write-Host "============================================="
          Write-Host "Initializing Persistent Storage"
          Write-Host "============================================="
          
          try {
              $storageRepo = "${{ github.event.inputs.storage_repo }}"
              $storageToken = "${{ github.event.inputs.storage_token }}"
              $storageDir = "C:\PersistentStorage"
              
              # Create storage directory
              if (-not (Test-Path $storageDir)) {
                  New-Item -ItemType Directory -Path $storageDir -Force
                  Write-Host "‚úÖ Created storage directory: $storageDir"
              }
              
              # Configure Git
              git config --global user.email "actions@github.com"
              git config --global user.name "GitHub Actions"
              
              # Clone repository
              $repoPath = "$storageDir\repo"
              if (-not (Test-Path $repoPath)) {
                  Write-Host "Cloning storage repository: $storageRepo"
                  git clone "https://oauth2:$storageToken@github.com/$storageRepo.git" $repoPath
                  Write-Host "‚úÖ Repository cloned successfully"
              } else {
                  Write-Host "Updating storage repository"
                  Set-Location $repoPath
                  git pull
                  Write-Host "‚úÖ Repository updated successfully"
              }
              
              Write-Host "‚úÖ Persistent storage initialized"
          } catch {
              Write-Warning "‚ö†Ô∏è Storage initialization failed: $_"
          }

      - name: ‚è≥ Keep Session Alive (with Storage Sync)
        run: |
          Write-Host "============================================="
          Write-Host "Starting Session Keep-Alive Process"
          Write-Host "============================================="
          
          $startTime = Get-Date
          $userName = "GitHubActionsUser"
          $rdpPort = "${{ github.event.inputs.rdp_port }}"
          $storageRepo = "${{ github.event.inputs.storage_repo }}"
          $storageToken = "${{ github.event.inputs.storage_token }}"
          $storageDir = "C:\PersistentStorage\repo"
          
          # Get public IP
          try {
              $publicIp = Invoke-RestMethod -Uri "http://ifconfig.me" -TimeoutSec 10
          } catch {
              $publicIp = "Unknown"
          }
          
          Write-Host "RDP Connection Details:"
          Write-Host "Computer: $publicIp`:$rdpPort"
          Write-Host "Username: $env:COMPUTERNAME\$userName"
          Write-Host "`n‚ö†Ô∏è  IMPORTANT: FOR LEARNING PURPOSES ONLY"
          Write-Host "Session will run for up to 6 hours"
          
          # Session monitoring loop
          $iteration = 0
          $lastStorageSync = Get-Date
          
          while ($true) {
              $iteration++
              $currentTime = Get-Date
              $elapsed = ($currentTime - $startTime).TotalMinutes
              
              # Display status every 10 minutes
              if ($iteration % 2 -eq 0) {
                  Write-Host "Session active for $([math]::Round($elapsed, 1)) minutes"
              }
              
              # Sync storage every 30 minutes if configured
              if ($storageRepo -ne '' -and $storageToken -ne '' -and (Test-Path $storageDir)) {
                  $timeSinceLastSync = ($currentTime - $lastStorageSync).TotalMinutes
                  if ($timeSinceLastSync -ge 30) {
                      Write-Host "Syncing persistent storage..."
                      try {
                          Set-Location $storageDir
                          git add .
                          git commit -m "Auto-sync: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" || exit 0
                          git pull
                          git push
                          Write-Host "‚úÖ Storage synced successfully"
                          $lastStorageSync = $currentTime
                      } catch {
                          Write-Warning "‚ö†Ô∏è Storage sync failed: $_"
                      }
                  }
              }
              
              # Sleep for 5 minutes
              Start-Sleep -Seconds 300
          }

      - name: üßπ Final Cleanup
        if: always()
        run: |
          Write-Host "============================================="
          Write-Host "Final Cleanup"
          Write-Host "============================================="
          
          try {
              # Final storage sync
              $storageRepo = "${{ github.event.inputs.storage_repo }}"
              $storageToken = "${{ github.event.inputs.storage_token }}"
              $storageDir = "C:\PersistentStorage\repo"
              
              if ($storageRepo -ne '' -and $storageToken -ne '' -and (Test-Path $storageDir)) {
                  Write-Host "Final storage sync..."
                  try {
                      Set-Location $storageDir
                      git add .
                      git commit -m "Final sync: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" || exit 0
                      git pull
                      git push
                      Write-Host "‚úÖ Final storage sync completed"
                  } catch {
                      Write-Warning "‚ö†Ô∏è Final storage sync failed: $_"
                  }
              }
              
              # Remove RDP user
              $userName = "GitHubActionsUser"
              if (Get-LocalUser -Name $userName -ErrorAction SilentlyContinue)) {
                  Write-Host "Removing RDP user: $userName"
                  Remove-LocalUser -Name $userName -Force
                  Write-Host "‚úÖ RDP user removed"
              }
              
              # Disable RDP
              Write-Host "Disabling Remote Desktop"
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1
              
              # Remove firewall rule
              Write-Host "Removing RDP firewall rule"
              netsh advfirewall firewall delete rule name="Allow RDP"
              
              Write-Host "‚úÖ Cleanup completed successfully"
              Write-Host "‚ö†Ô∏è  REMINDER: This was for LEARNING PURPOSES ONLY"
          } catch {
              Write-Error "‚ùå Cleanup failed: $_"
          }
