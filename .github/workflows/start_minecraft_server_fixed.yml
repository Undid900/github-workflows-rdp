name: Minecraft Server with Persistent Storage and Shaders (Max Performance)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      server_version:
        description: 'Minecraft server version'
        required: true
        default: '1.21.1'
      max_players:
        description: 'Maximum number of players'
        required: true
        default: '100'
      memory_allocation:
        description: 'Memory allocation (e.g., 16G)'
        required: true
        default: '16G'
      cpu_cores:
        description: 'CPU cores to use (e.g., 4)'
        required: true
        default: '4'

jobs:
  run-minecraft-server:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Create working directories
      run: |
        mkdir -p minecraft-server
        mkdir -p minecraft-data
        mkdir -p minecraft-data/shaderpacks
        mkdir -p minecraft-data/config
        mkdir -p minecraft-data/mods

    - name: Download PaperMC server
      run: |
        cd minecraft-server
        wget -O paper.jar https://api.papermc.io/v2/projects/paper/versions/${{ github.event.inputs.server_version || '1.21.1' }}/builds/latest/downloads/paper-${{ github.event.inputs.server_version || '1.21.1' }}-latest.jar

    - name: Create server.properties
      run: |
        cat > minecraft-server/server.properties << EOF
        # Minecraft server properties
        # Generated by GitHub Actions (Max Performance Configuration)
        generator-settings=
        op-permission-level=4
        allow-nether=true
        level-name=world
        enable-query=false
        allow-flight=false
        announce-player-achievements=true
        server-port=25565
        max-world-size=29999984
        level-type=default
        enable-rcon=false
        level-seed=
        force-gamemode=false
        server-ip=
        network-compression-threshold=256
        max-build-height=256
        spawn-npcs=true
        white-list=false
        spawn-animals=true
        snooper-enabled=true
        difficulty=1
        function-permission-level=2
        gamemode=0
        max-players=${{ github.event.inputs.max_players || '100' }}
        spawn-monsters=true
        view-distance=15
        generate-structures=true
        online-mode=true
        max-tick-time=60000
        player-idle-timeout=0
        motd=Minecraft Server (Max Performance) powered by GitHub Actions
        enable-command-block=false
        spawn-protection=16
        resource-pack=
        EOF

    - name: Create eula.txt
      run: |
        echo "eula=true" > minecraft-server/eula.txt

    - name: Create start script with MAX PERFORMANCE settings
      run: |
        cat > minecraft-server/start.sh << EOF
        #!/bin/bash
        cd $(pwd)/minecraft-server
        
        # MAX PERFORMANCE JVM Arguments
        java -Xms${{ github.event.inputs.memory_allocation || '16G' }} -Xmx${{ github.event.inputs.memory_allocation || '16G' }} \
        -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=100 \
        -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC \
        -XX:+AlwaysPreTouch -XX:G1NewSizePercent=40 -XX:G1MaxNewSizePercent=50 \
        -XX:G1HeapRegionSize=16M -XX:G1ReservePercent=15 -XX:G1HeapWastePercent=5 \
        -XX:G1MixedGCCountTarget=8 -XX:InitiatingHeapOccupancyPercent=10 \
        -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 \
        -XX:SurvivorRatio=64 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1 \
        -XX:+UseLargePages -XX:+UseTransparentHugePages \
        -XX:+UseNUMA -XX:NumaInterleaving=all \
        -XX:ParallelGCThreads=${{ github.event.inputs.cpu_cores || '4' }} \
        -XX:ConcGCThreads=$(( (${{ github.event.inputs.cpu_cores || '4' }} + 1) / 2 )) \
        -XX:G1ConcRefinementThreads=${{ github.event.inputs.cpu_cores || '4' }} \
        -XX:+UseStringDeduplication -XX:+OptimizeStringConcat \
        -XX:+EliminateLocks -XX:+UseBiasedLocking \
        -XX:+AggressiveOpts -XX:+AggressiveHeap \
        -XX:+UseFastAccessorMethods -XX:+UseCompressedOops \
        -XX:+UseCompressedClassPointers -XX:+DisableAttachMechanism \
        -Dusing.aikars.flags=https://mcflags.emc.gs -Daikars.new.flags=true \
        -Dfml.readTimeout=90 -Dfml.writeTimeout=90 \
        -Dio.netty.eventLoopThreads=${{ github.event.inputs.cpu_cores || '4' }} \
        -Dnet.minecraft.server.jmxremote=true \
        -jar paper.jar nogui
        EOF
        chmod +x minecraft-server/start.sh

    - name: Create restart script
      run: |
        cat > minecraft-server/restart.sh << EOF
        #!/bin/bash
        echo "Restarting Minecraft server..."
        pkill -f paper.jar
        sleep 5
        ./start.sh > server.log 2>&1 &
        echo "Server restarted"
        EOF
        chmod +x minecraft-server/restart.sh

    - name: Create backup script
      run: |
        cat > minecraft-server/backup.sh << EOF
        #!/bin/bash
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BACKUP_DIR="../minecraft-data/backups"
        mkdir -p \$BACKUP_DIR
        echo "Creating backup: \$TIMESTAMP"
        zip -r \$BACKUP_DIR/world_backup_\$TIMESTAMP.zip ../minecraft-data/world
        echo "Backup completed: \$BACKUP_DIR/world_backup_\$TIMESTAMP.zip"
        # Keep only last 14 backups for max performance servers
        ls -tp \$BACKUP_DIR/world_backup_*.zip | grep -v '/$' | tail -n +15 | xargs -I {} rm -- {}
        EOF
        chmod +x minecraft-server/backup.sh

    - name: Download and configure HIGH PERFORMANCE shaders
      run: |
        # Download Sildur's Vibrant Shaders (High Performance version)
        cd minecraft-data/shaderpacks
        wget -O sildurs_shaders.zip https://www.curseforge.com/minecraft/customization/sildurs-vibrant-shaders/download/3945625/file
        
        # Extract shader pack
        unzip sildurs_shaders.zip -d sildurs_vibrant_shaders
        rm sildurs_shaders.zip
        
        # Create HIGH PERFORMANCE shaders.properties configuration
        cat > minecraft-data/config/shaders.properties << EOF
        # HIGH PERFORMANCE Shaders configuration
        clouds=fast
        oldHandLight=true
        dynamicHandLight=true
        oldLighting=true
        shadowTerrain=true
        shadowTranslucent=false
        shadowEntities=false
        shadowBlockEntities=false
        underwaterOverlay=true
        sun=true
        moon=true
        vignette=false
        backFace.solid=false
        backFace.cutout=false
        backFace.cutoutMipped=false
        backFace.translucent=false
        rain.depth=true
        beacon.beam.depth=true
        separateAo=false
        frustum.culling=true
        shadow.culling=true
        particles.before.deferred=false
        
        # Performance optimizations
        shadow.map.resolution=1024
        shadow.distance=64.0
        shadow.filtering=2x
        shadow.quality=low
        ao.level=0
        ao.sample.count=8
        bloom.level=0.1
        motion.blur.level=0.0
        depth.of.field.level=0.0
        
        # Texture settings
        texture.composite.colortex1=textures/noise.png
        texture.composite.colortex2=minecraft:textures/font/ascii.png
        texture.composite.colortex3=minecraft:dynamic/lightmap_1
        texture.composite.colortex4=minecraft:textures/atlas/blocks.png
        
        # Version requirements
        version.1.21.1=I7
        EOF

    - name: Configure Paper server MAXIMUM PERFORMANCE
      run: |
        cat > minecraft-server/paper.yml << EOF
        version: '1.21.1'
        settings:
          enable-player-collisions: false
          save-empty-scoreboard-teams: false
          use-alternative-luck-formula: true
          load-permissions-yml-before-plugins: true
          region-file-cache-size: 512
          suggest-player-names-when-null-tab-completions: true
          bungee-online-mode: true
          velocity-support:
            enabled: false
            online-mode: true
            secret: ''
          console-hide-batch-commands: true
          spam-limiter:
            tab-spam-increment: 1
            tab-spam-limit: 1000
        timings:
          enabled: true
          verbose: true
          server-name: High Performance Server
          ping-interval: 15
          server-info:
            website: ''
            ip: ''
            port: 0
            contact: ''
          hidden-config-entries:
            - database
            - settings.bungeecord-addresses
            - settings.velocity-support.secret
          history-interval: 300
          history-length: 3600
        worlds:
          world:
            verbose: true
            adjust-lighting-delay: 0
            auto-save-interval: 300
            dragon-death-sound-radius: 0
            seed-based-feature-search: true
            keep-spawn-loaded: true
            keep-spawn-loaded-range: 15
            optimize-explosions: true
            entity-per-chunk-save-limit:
              experience_orb: -1
              arrow: -1
            fix-zero-tick: true
            grass-spread-tick-rate: 2
            max-auto-save-chunks-per-tick: 48
            mob-spawner-tick-rate: 1
            container-update-tick-rate: 1
            disable-thunder: false
            disable-ice-and-snow: false
            keep-spawn-loaded: true
            portal-search-radius: 128
            portal-create-radius: 16
            # MAX PERFORMANCE optimizations
            use-faster-eigencraft-redstone: true
            use-new-lighting-engine: true
            enable-tnt-optimizations: true
            enable-redstone-optimizations: true
            optimize-explosions: true
            fix-climbing-bypassing-cramming-rule: true
            armor-stands-do-collision-entity-lookups: false
            prevent-moving-into-unloaded-chunks: true
            filter-nbt-data-from-spawn-eggs-and-related: true
            disable-chest-cat-detection: true
            disable-legacy-boss-bar-api: true
            disable-explosion-knockback: false
            disable-relaxed-spawn-chunks: false
            mob-spawner-tick-rate: 1
            container-update-tick-rate: 1
            max-entity-collisions: 8
            grass-spread-tick-rate: 2
            disable-ice-and-snow: false
            allow-permanent-block-break-exploits: false
            allow-leashing-undead-horse: false
            allow-zombie-pigmen-to-transform-through-portals: true
            baby-zombie-movement-modifier: 0.5
            spawner-nerfed-mobs-should-jump: false
            parrots-are-unaffected-by-player-movement: false
            disable-end-credits: false
            skeleton-horse-thunder-spawn-chance: 0.01
            fix-water-pushing-entities: true
            fix-items-merging-through-walls: true
            disable-player-crits: false
            iron-golems-can-spawn-in-air: false
            villagers-see-farther: false
            villagers-update-pathfinding-on-block-update: false
            enable-treasure-maps: true
            treasure-maps-return-already-discovered: false
            disable-mob-spawner-spawn-egg-transformation: false
            disable-teleportation-pilling: true
            enable-command-block-output: true
            enable-entity-activation-range: true
            entity-activation-range:
              animals: 32
              monsters: 32
              raiders: 48
              misc: 16
              water: 16
              villagers: 32
              flying-monsters: 32
            entity-tracking-range:
              players: 48
              animals: 48
              monsters: 48
              misc: 32
              other: 64
            tick-rates:
              tile: 3
              entity: 3
        EOF

    - name: Configure Spigot MAX PERFORMANCE
      run: |
        cat > minecraft-server/spigot.yml << EOF
        settings:
          debug: false
          save-user-cache-on-stop-only: true
          moved-wrongly-threshold: 0.0625
          moved-too-quickly-multiplier: 10.0
          timeout-time: 60
          restart-on-crash: true
          restart-script: ./restart.sh
          netty-threads: ${{ github.event.inputs.cpu_cores || '4' }}
          attribute:
            maxHealth:
              max: 2048.0
            movementSpeed:
              max: 2048.0
            attackDamage:
              max: 2048.0
        worlds:
          world:
            verbose: true
            spawn-limits:
              monsters: 100
              animals: 20
              water-animals: 10
              water-ambient: 40
              ambient: 30
            entity-activation-range:
              animals: 48
              monsters: 48
              raiders: 64
              misc: 32
              water: 32
              villagers: 48
              flying-monsters: 48
            ticks-per:
              animal-spawns: 400
              monster-spawns: 1
              water-spawns: 1
              water-ambient-spawns: 1
              ambient-spawns: 1
              villager-spawns: 1
              autosave: 3000
            merge-radius:
              exp: 4.0
              item: 3.5
            view-distance: 15
            simulation-distance: 10
            max-chunk-sends-per-tick: 64
            max-chunk-gc-per-tick: 64
            max-entity-collisions: 8
            arrow-despawn-rate: 1200
            tile-max-tick-time: 50
            entity-max-tick-time: 50
            growth:
              cactus-modifier: 100
              cane-modifier: 100
              melon-modifier: 100
              mushroom-modifier: 100
              pumpkin-modifier: 100
              sapling-modifier: 100
              wheat-modifier: 100
              netherwart-modifier: 100
              vine-modifier: 100
              cocoa-modifier: 100
              bamboo-modifier: 100
              sweetberry-modifier: 100
              kelp-modifier: 100
            entity-activation-range:
              animals: 48
              monsters: 48
              raiders: 64
              misc: 32
              water: 32
              villagers: 48
              flying-monsters: 48
            entity-tracking-range:
              players: 64
              animals: 64
              monsters: 64
              misc: 48
              other: 80
        EOF

    - name: Configure Bukkit MAX PERFORMANCE
      run: |
        cat > minecraft-server/bukkit.yml << EOF
        settings:
          allow-end: true
          warn-on-overload: true
          permissions-file: permissions.yml
          update-folder: update
          plugin-profiling: false
          connection-throttle: 2000
          query-plugins: true
          deprecated-verbose: default
          shutdown-message: Server closed
          minimum-api: 1.13
          spawn-limits:
            monsters: 100
            animals: 20
            water-animals: 10
            water-ambient: 40
            ambient: 30
          entity-activation-range:
            animals: 48
            monsters: 48
            raiders: 64
            misc: 32
            water: 32
            villagers: 48
            flying-monsters: 48
          ticks-per:
            animal-spawns: 400
            monster-spawns: 1
            water-spawns: 1
            water-ambient-spawns: 1
            ambient-spawns: 1
            villager-spawns: 1
            autosave: 3000
          merge-radius:
            exp: 4.0
            item: 3.5
          view-distance: 15
          simulation-distance: 10
        worlds:
          world:
            seed: 0
            generator: null
            environment: normal
            generate-structures: true
            adjust-lighting-delay: 0
            spawn-limits:
              monsters: 100
              animals: 20
              water-animals: 10
              water-ambient: 40
              ambient: 30
            entity-activation-range:
              animals: 48
              monsters: 48
              raiders: 64
              misc: 32
              water: 32
              villagers: 48
              flying-monsters: 48
            ticks-per:
              animal-spawns: 400
              monster-spawns: 1
              water-spawns: 1
              water-ambient-spawns: 1
              ambient-spawns: 1
              villager-spawns: 1
              autosave: 3000
            merge-radius:
              exp: 4.0
              item: 3.5
        EOF

    - name: Create plugins directory with PERFORMANCE plugins
      run: |
        mkdir -p minecraft-server/plugins
        mkdir -p minecraft-server/plugins/ServerShaderGateEnforcer
        mkdir -p minecraft-server/plugins/Spark
        mkdir -p minecraft-server/plugins/LuckPerms
        
        # Add Server Shader Gate & Enforcer plugin configuration
        cat > minecraft-server/plugins/ServerShaderGateEnforcer/ssge.yml << EOF
        require_enabled: true
        shader_file: 'sildurs_vibrant_shaders'
        shader_options: ''
        size_shader: 0
        size_options: 0
        shader_hash: ''
        require_shader: true
        require_options: false
        link: 'https://www.curseforge.com/minecraft/customization/sildurs-vibrant-shaders'
        exempt_players: []
        EOF
        
        # Add Spark profiler configuration for performance monitoring
        cat > minecraft-server/plugins/Spark/config.yml << EOF
        spark:
          sampling:
            default-interval: 1
            default-duration: 60
            default-threads: ${{ github.event.inputs.cpu_cores || '4' }}
          web:
            enabled: true
            port: 4040
            host: 0.0.0.0
          metrics:
            enabled: true
            interval: 10
            history-length: 60
          profiler:
            enabled: true
            auto-start: false
        EOF

    - name: Install ADDITIONAL PERFORMANCE tools
      run: |
        # Install htop, glances, and other monitoring tools
        sudo apt-get update
        sudo apt-get install -y htop glances iotop iftop nmon sysstat
        
        # Install Java performance tools
        sudo apt-get install -y openjdk-21-jdk openjdk-21-jre
        
        # Install network optimization tools
        sudo apt-get install -y ethtool net-tools
        
        # Configure system for MAX PERFORMANCE
        echo "Configuring system for maximum performance..."
        
        # Disable swap for better performance
        sudo swapoff -a
        sudo sed -i '/swap/s/^/#/' /etc/fstab
        
        # Configure sysctl for network performance
        cat > /tmp/sysctl.conf << EOF
        # Network performance optimizations
        net.core.rmem_max=16777216
        net.core.wmem_max=16777216
        net.core.rmem_default=16777216
        net.core.wmem_default=16777216
        net.core.optmem_max=40960
        net.ipv4.tcp_rmem=4096 87380 16777216
        net.ipv4.tcp_wmem=4096 65536 16777216
        net.ipv4.tcp_mtu_probing=1
        net.ipv4.tcp_syncookies=1
        net.ipv4.tcp_max_syn_backlog=8192
        net.ipv4.tcp_fin_timeout=30
        net.ipv4.tcp_keepalive_time=1200
        net.ipv4.tcp_window_scaling=1
        net.ipv4.tcp_sack=1
        net.core.netdev_max_backlog=5000
        net.ipv4.tcp_no_metrics_save=1
        net.ipv4.tcp_slow_start_after_idle=0
        
        # File system performance
        vm.dirty_ratio=10
        vm.dirty_background_ratio=5
        vm.dirty_expire_centisecs=100
        vm.dirty_writeback_centisecs=100
        
        # Memory management
        vm.swappiness=0
        vm.vfs_cache_pressure=50
        vm.overcommit_memory=1
        EOF
        sudo cp /tmp/sysctl.conf /etc/sysctl.d/99-minecraft.conf
        sudo sysctl -p /etc/sysctl.d/99-minecraft.conf
        
        # Configure limits.conf
        cat > /tmp/limits.conf << EOF
        * soft nofile 1048576
        * hard nofile 1048576
        * soft nproc 1048576
        * hard nproc 1048576
        * soft memlock unlimited
        * hard memlock unlimited
        EOF
        sudo cp /tmp/limits.conf /etc/security/limits.d/99-minecraft.conf

    - name: Start Minecraft server with MAX PERFORMANCE
      run: |
        cd minecraft-server
        ./start.sh > server.log 2>&1 &
        echo "Server started in background with MAX PERFORMANCE settings"

    - name: Wait for server to start
      run: |
        echo "Waiting for server to start..."
        sleep 60
        echo "Server should be running now"

    - name: Test server connection
      run: |
        nc -zv localhost 25565 || echo "Server connection test failed"

    - name: Set up AGGRESSIVE auto-restart
      run: |
        # Set up cron job for auto-restart every 4 hours for max performance
        (crontab -l 2>/dev/null; echo "0 */4 * * * $(pwd)/minecraft-server/restart.sh") | crontab -

    - name: Set up FREQUENT auto-backup
      run: |
        # Set up cron job for auto-backup every 12 hours
        (crontab -l 2>/dev/null; echo "0 */12 * * * $(pwd)/minecraft-server/backup.sh") | crontab -

    - name: Set up DAILY auto-update
      run: |
        # Set up daily update check for max performance servers
        (crontab -l 2>/dev/null; echo "0 0 * * * cd $(pwd)/minecraft-server && wget -O paper.jar https://api.papermc.io/v2/projects/paper/versions/${{ github.event.inputs.server_version || '1.21.1' }}/builds/latest/downloads/paper-${{ github.event.inputs.server_version || '1.21.1' }}-latest.jar") | crontab -

    - name: Configure ADVANCED log rotation
      run: |
        # Set up log rotation with compression
        cat > /tmp/minecraft-logrotate.conf << EOF
        $(pwd)/minecraft-server/server.log {
            hourly
            rotate 24
            compress
            delaycompress
            missingok
            notifempty
            create 640 root root
            postrotate
                /bin/kill -HUP \$(cat /var/run/syslogd.pid 2>/dev/null) 2>/dev/null || true
            endscript
        }
        $(pwd)/minecraft-server/debug.log {
            daily
            rotate 7
            compress
            delaycompress
            missingok
            notifempty
            create 640 root root
        }
        $(pwd)/minecraft-server/latest.log {
            daily
            rotate 7
            compress
            delaycompress
            missingok
            notifempty
            create 640 root root
        }
        EOF
        sudo cp /tmp/minecraft-logrotate.conf /etc/logrotate.d/minecraft
        sudo chmod 644 /etc/logrotate.d/minecraft
        sudo logrotate -f /etc/logrotate.d/minecraft

    - name: Configure FIREWALL with PERFORMANCE settings
      run: |
        # Open Minecraft port 25565 and monitoring ports
        sudo ufw allow 25565/tcp
        sudo ufw allow 25565/udp
        sudo ufw allow 4040/tcp  # Spark profiler
        sudo ufw allow 8080/tcp  # Web dashboard
        sudo ufw --force enable
        sudo ufw reload

    - name: Configure ADVANCED monitoring
      run: |
        # Create comprehensive monitoring script
        cat > minecraft-server/monitor.sh << EOF
        #!/bin/bash
        echo "=== MINECRAFT SERVER HIGH PERFORMANCE MONITORING ==="
        echo "Date: \$(date)"
        echo "Server status: \$(pgrep -f paper.jar > /dev/null && echo "Running" || echo "Stopped")"
        
        # System resources
        echo -e "\n=== SYSTEM RESOURCES ==="
        echo "CPU usage: \$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - \$1"%"}')"
        echo "Memory usage: \$(free -h | grep Mem | awk '{print \$3"/"\$2" ("\$4" free)"}')"
        echo "Swap usage: \$(free -h | grep Swap | awk '{print \$3"/"\$2}')"
        echo "Disk usage: \$(df -h . | grep -v Filesystem | awk '{print \$3"/"\$2" "\$5}')"
        
        # Network
        echo -e "\n=== NETWORK ==="
        echo "IP address: \$(curl -s http://checkip.amazonaws.com)"
        echo "Open ports: \$(netstat -tuln | grep LISTEN | grep -E '25565|4040|8080' | wc -l)"
        
        # Minecraft server specific
        echo -e "\n=== MINECRAFT SERVER ==="
        echo "Players online: \$(cd $(pwd)/minecraft-server && echo "list" | nc localhost 25575 2>/dev/null | grep -E '[0-9]+ online' | awk '{print \$1}')"
        echo "TPS: \$(cd $(pwd)/minecraft-server && echo "tps" | nc localhost 25575 2>/dev/null | grep -E '[0-9]+\.[0-9]+' | head -n1)"
        echo "RAM usage: \$(ps aux | grep paper.jar | grep -v grep | awk '{print \$6/1024 " MB"}')"
        echo "CPU usage: \$(ps aux | grep paper.jar | grep -v grep | awk '{print \$3 "%"}')"
        
        # Performance metrics
        echo -e "\n=== PERFORMANCE METRICS ==="
        echo "Chunk load: \$(cd $(pwd)/minecraft-server && echo "chunkinfo" | nc localhost 25575 2>/dev/null | grep -E '[0-9]+ loaded' | awk '{print \$1}')"
        echo "Entity count: \$(cd $(pwd)/minecraft-server && echo "entitycount" | nc localhost 25575 2>/dev/null | grep -E '[0-9]+ total' | awk '{print \$1}')"
        echo "Tick time: \$(cd $(pwd)/minecraft-server && echo "tickinfo" | nc localhost 25575 2>/dev/null | grep -E '[0-9]+\.[0-9]+ms' | head -n1)"
        
        # Save to log
        echo -e "\n====================================="
        EOF
        chmod +x minecraft-server/monitor.sh
        
        # Set up monitoring cron job
        (crontab -l 2>/dev/null; echo "*/5 * * * * $(pwd)/minecraft-server/monitor.sh >> $(pwd)/minecraft-server/monitor.log") | crontab -

    - name: Save server data with VERSIONING
      run: |
        # Save server data to GitHub repository with versioning
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add minecraft-data/
        git commit -m "Update Minecraft server data (MAX PERFORMANCE) $(date +%Y-%m-%d_%H-%M-%S)" || echo "No changes to commit"
        git push origin main || echo "Push failed, possibly no changes"

    - name: Display MAX PERFORMANCE server information
      run: |
        echo "====================================="
        echo "MINECRAFT SERVER - MAX PERFORMANCE"
        echo "====================================="
        echo "Server IP: $(curl -s http://checkip.amazonaws.com)"
        echo "Server Port: 25565"
        echo "Minecraft Version: ${{ github.event.inputs.server_version || '1.21.1' }}"
        echo "Max Players: ${{ github.event.inputs.max_players || '100' }}"
        echo "Memory Allocation: ${{ github.event.inputs.memory_allocation || '16G' }}"
        echo "CPU Cores: ${{ github.event.inputs.cpu_cores || '4' }}"
        echo "Shaders: Sildur's Vibrant Shaders (High Performance)"
        echo "====================================="
        echo "PERFORMANCE FEATURES:"
        echo " - MAXIMUM JVM optimizations"
        echo " - HIGH PERFORMANCE shaders configuration"
        echo " - ADVANCED server optimizations"
        echo " - AGGRESSIVE auto-restart (every 4 hours)"
        echo " - FREQUENT backups (every 12 hours)"
        echo " - DAILY updates"
        echo " - ADVANCED monitoring"
        echo "====================================="
        echo "Server commands:"
        echo " - Start: ./minecraft-server/start.sh"
        echo " - Restart: ./minecraft-server/restart.sh"
        echo " - Backup: ./minecraft-server/backup.sh"
        echo " - Monitor: ./minecraft-server/monitor.sh"
        echo " - Profile: ./minecraft-server/spark profile"
        echo "====================================="

    - name: Keep workflow running with HEALTH CHECKS
      run: |
        # Keep the workflow running with health checks
        while true; do
          # Check server status every 5 minutes
          if ! pgrep -f paper.jar > /dev/null; then
            echo "Server not running, restarting..."
            $(pwd)/minecraft-server/restart.sh
          fi
          
          # Run monitoring
          $(pwd)/minecraft-server/monitor.sh >> $(pwd)/minecraft-server/health_check.log
          
          sleep 300
        done