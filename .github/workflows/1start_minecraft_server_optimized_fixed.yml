name: Deploy Optimized Minecraft Server

on:
  workflow_dispatch:
    inputs:
      server_version:
        description: 'Minecraft Server Version (e.g., 1.21.1)'
        required: true
        default: '1.21.1'
      memory_allocation:
        description: 'Memory Allocation (e.g., 8G, 16G)'
        required: true
        default: '8G'
      cpu_cores:
        description: 'CPU Cores to Use'
        required: true
        default: '4'
      max_players:
        description: 'Maximum Players'
        required: true
        default: '50'
      server_name:
        description: 'Server MOTD'
        required: true
        default: 'Optimized Minecraft Server'

jobs:
  deploy-minecraft-server:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create working directories
      run: |
        mkdir -p minecraft-server
        mkdir -p minecraft-data
        mkdir -p minecraft-data/shaderpacks
        mkdir -p minecraft-data/config
        mkdir -p minecraft-data/mods
        mkdir -p minecraft-data/backups
        mkdir -p minecraft-data/logs
        
    - name: Download PaperMC server
      run: |
        cd minecraft-server
        wget -O paper.jar "https://api.papermc.io/v2/projects/paper/versions/${{ github.event.inputs.server_version }}/builds/latest/downloads/paper-${{ github.event.inputs.server_version }}-latest.jar"
        if [ ! -f paper.jar ]; then
          echo "Failed to download PaperMC server"
          exit 1
        fi
        
    - name: Create server.properties
      run: |
        cat > minecraft-server/server.properties << EOF
        # Minecraft server properties
        # Generated by GitHub Actions (Optimized Configuration)
        generator-settings=
        op-permission-level=4
        allow-nether=true
        level-name=world
        enable-query=false
        allow-flight=true
        announce-player-achievements=true
        server-port=25565
        max-world-size=29999984
        level-type=default
        enable-rcon=false
        level-seed=
        force-gamemode=false
        server-ip=
        network-compression-threshold=256
        max-build-height=256
        spawn-npcs=true
        white-list=true
        spawn-animals=true
        snooper-enabled=false
        difficulty=1
        function-permission-level=2
        gamemode=0
        max-players=${{ github.event.inputs.max_players }}
        spawn-monsters=true
        view-distance=10
        generate-structures=true
        online-mode=true
        max-tick-time=60000
        player-idle-timeout=30
        motd=${{ github.event.inputs.server_name }}
        enable-command-block=true
        spawn-protection=16
        resource-pack=
        EOF
        
    - name: Create eula.txt
      run: |
        echo "eula=true" > minecraft-server/eula.txt
        
    - name: Create optimized start script
      run: |
        cat > minecraft-server/start.sh << EOF
        #!/bin/bash
        cd $(pwd)/minecraft-server
        
        # Optimized JVM Arguments for Performance and Stability
        java -Xms${{ github.event.inputs.memory_allocation }} -Xmx${{ github.event.inputs.memory_allocation }} \
        -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 \
        -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC \
        -XX:+AlwaysPreTouch -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 \
        -XX:G1HeapRegionSize=16M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 \
        -XX:G1MixedGCCountTarget=8 -XX:InitiatingHeapOccupancyPercent=15 \
        -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 \
        -XX:SurvivorRatio=64 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1 \
        -XX:+UseLargePages -XX:+UseTransparentHugePages \
        -XX:+UseNUMA -XX:NumaInterleaving=all \
        -XX:ParallelGCThreads=${{ github.event.inputs.cpu_cores }} \
        -XX:ConcGCThreads=$(( (${{ github.event.inputs.cpu_cores }} + 1) / 2 )) \
        -XX:G1ConcRefinementThreads=${{ github.event.inputs.cpu_cores }} \
        -XX:+UseStringDeduplication -XX:+OptimizeStringConcat \
        -XX:+EliminateLocks -XX:+UseBiasedLocking \
        -XX:+AggressiveOpts -XX:+UseFastAccessorMethods \
        -XX:+UseCompressedOops -XX:+UseCompressedClassPointers \
        -Dusing.aikars.flags=https://mcflags.emc.gs -Daikars.new.flags=true \
        -Dfml.readTimeout=90 -Dfml.writeTimeout=90 \
        -Dio.netty.eventLoopThreads=${{ github.event.inputs.cpu_cores }} \
        -Dnet.minecraft.server.jmxremote=true \
        -jar paper.jar nogui
        EOF
        chmod +x minecraft-server/start.sh
        
    - name: Create safe restart script
      run: |
        cat > minecraft-server/restart.sh << EOF
        #!/bin/bash
        echo "Starting safe server restart..."
        
        # Check if server is running
        if pgrep -f paper.jar > /dev/null; then
          echo "Sending stop command to server..."
          # Send stop command via rcon if available
          if command -v mcrcon &> /dev/null; then
            mcrcon -H localhost -P 25575 -p "your_rcon_password" stop
          else
            # Alternative: Find screen session and send stop command
            screen -S minecraft -X stuff "stop\n"
          fi
          
          # Wait for server to shutdown
          echo "Waiting for server to shutdown..."
          for i in {1..30}; do
            if ! pgrep -f paper.jar > /dev/null; then
              echo "Server stopped successfully"
              break
            fi
            sleep 1
          done
          
          # Force kill if still running
          if pgrep -f paper.jar > /dev/null; then
            echo "Forcing server shutdown..."
            pkill -f paper.jar
            sleep 5
          fi
        fi
        
        # Start server
        echo "Starting server..."
        cd $(pwd)/minecraft-server
        ./start.sh > server.log 2>&1 &
        echo "Server restart initiated"
        EOF
        chmod +x minecraft-server/restart.sh
        
    - name: Create comprehensive backup script
      run: |
        cat > minecraft-server/backup.sh << EOF
        #!/bin/bash
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BACKUP_DIR="$(pwd)/minecraft-data/backups"
        SERVER_DIR="$(pwd)/minecraft-server"
        
        echo "Starting backup process: \$TIMESTAMP"
        
        # Create backup directory if it doesn't exist
        mkdir -p \$BACKUP_DIR
        
        # Check if server is running
        SERVER_RUNNING=false
        if pgrep -f paper.jar > /dev/null; then
          SERVER_RUNNING=true
          echo "Server is running, creating safe backup..."
          
          # Send save-all command
          if command -v mcrcon &> /dev/null; then
            mcrcon -H localhost -P 25575 -p "your_rcon_password" save-all
            mcrcon -H localhost -P 25575 -p "your_rcon_password" save-off
          else
            screen -S minecraft -X stuff "save-all\n"
            screen -S minecraft -X stuff "save-off\n"
          fi
          sleep 5
        fi
        
        # Create world backup
        echo "Creating world backup..."
        zip -r \$BACKUP_DIR/world_backup_\$TIMESTAMP.zip \$SERVER_DIR/world/ \
          \$SERVER_DIR/world_nether/ \$SERVER_DIR/world_the_end/
        
        # Create configuration backup
        echo "Creating configuration backup..."
        zip -r \$BACKUP_DIR/config_backup_\$TIMESTAMP.zip \$SERVER_DIR/server.properties \
          \$SERVER_DIR/paper.yml \$SERVER_DIR/spigot.yml \$SERVER_DIR/bukkit.yml \
          \$SERVER_DIR/plugins/ \$SERVER_DIR/whitelist.json
        
        # Resume saving if server was running
        if [ "\$SERVER_RUNNING" = true ]; then
          if command -v mcrcon &> /dev/null; then
            mcrcon -H localhost -P 25575 -p "your_rcon_password" save-on
          else
            screen -S minecraft -X stuff "save-on\n"
          fi
        fi
        
        echo "Backup completed successfully"
        echo "Backup files:"
        ls -lh \$BACKUP_DIR/*_\$TIMESTAMP.zip
        
        # Cleanup old backups (keep last 14 days)
        echo "Cleaning up old backups..."
        find \$BACKUP_DIR -name "*.zip" -type f -mtime +14 -delete
        
        # Verify backup integrity
        echo "Verifying backup integrity..."
        for backup in \$BACKUP_DIR/*_\$TIMESTAMP.zip; do
          if zip -T \$backup; then
            echo "Backup \$backup is valid"
          else
            echo "WARNING: Backup \$backup may be corrupted"
          fi
        done
        EOF
        chmod +x minecraft-server/backup.sh
        
    - name: Configure Paper server optimizations
      run: |
        cat > minecraft-server/paper.yml << EOF
        version: '${{ github.event.inputs.server_version }}'
        settings:
          enable-player-collisions: false
          save-empty-scoreboard-teams: false
          use-alternative-luck-formula: true
          load-permissions-yml-before-plugins: true
          region-file-cache-size: 512
          suggest-player-names-when-null-tab-completions: true
          bungee-online-mode: true
          velocity-support:
            enabled: false
            online-mode: true
            secret: ''
          console-hide-batch-commands: true
          spam-limiter:
            tab-spam-increment: 1
            tab-spam-limit: 1000
        timings:
          enabled: true
          verbose: true
          server-name: ${{ github.event.inputs.server_name }}
          ping-interval: 15
          server-info:
            website: ''
            ip: ''
            port: 0
            contact: ''
          hidden-config-entries:
            - database
            - settings.bungeecord-addresses
            - settings.velocity-support.secret
          history-interval: 300
          history-length: 3600
        worlds:
          world:
            verbose: true
            adjust-lighting-delay: 0
            auto-save-interval: 300
            dragon-death-sound-radius: 0
            seed-based-feature-search: true
            keep-spawn-loaded: true
            keep-spawn-loaded-range: 15
            optimize-explosions: true
            entity-per-chunk-save-limit:
              experience_orb: -1
              arrow: -1
            fix-zero-tick: true
            grass-spread-tick-rate: 2
            max-auto-save-chunks-per-tick: 48
            mob-spawner-tick-rate: 1
            container-update-tick-rate: 1
            disable-thunder: false
            disable-ice-and-snow: false
            portal-search-radius: 128
            portal-create-radius: 16
            # Performance optimizations
            use-faster-eigencraft-redstone: true
            use-new-lighting-engine: true
            enable-tnt-optimizations: true
            enable-redstone-optimizations: true
            optimize-explosions: true
            fix-climbing-bypassing-cramming-rule: true
            armor-stands-do-collision-entity-lookups: false
            prevent-moving-into-unloaded-chunks: true
            filter-nbt-data-from-spawn-eggs-and-related: true
            disable-chest-cat-detection: true
            disable-legacy-boss-bar-api: true
            disable-explosion-knockback: false
            disable-relaxed-spawn-chunks: false
            mob-spawner-tick-rate: 1
            container-update-tick-rate: 1
            max-entity-collisions: 8
            grass-spread-tick-rate: 2
            disable-ice-and-snow: false
            allow-permanent-block-break-exploits: false
            allow-leashing-undead-horse: false
            allow-zombie-pigmen-to-transform-through-portals: true
            baby-zombie-movement-modifier: 0.5
            spawner-nerfed-mobs-should-jump: false
            parrots-are-unaffected-by-player-movement: false
            disable-end-credits: false
            skeleton-horse-thunder-spawn-chance: 0.01
            fix-water-pushing-entities: true
            fix-items-merging-through-walls: true
            disable-player-crits: false
            iron-golems-can-spawn-in-air: false
            villagers-see-farther: false
            villagers-update-pathfinding-on-block-update: false
            enable-treasure-maps: true
            treasure-maps-return-already-discovered: false
            disable-mob-spawner-spawn-egg-transformation: false
            disable-teleportation-pilling: true
            enable-command-block-output: true
            enable-entity-activation-range: true
            entity-activation-range:
              animals: 32
              monsters: 32
              raiders: 48
              misc: 16
              water: 16
              villagers: 32
              flying-monsters: 32
            entity-tracking-range:
              players: 48
              animals: 48
              monsters: 48
              misc: 32
              other: 64
            tick-rates:
              tile: 3
              entity: 3
        EOF
        
    - name: Configure Spigot optimizations
      run: |
        cat > minecraft-server/spigot.yml << EOF
        settings:
          debug: false
          save-user-cache-on-stop-only: true
          moved-wrongly-threshold: 0.0625
          moved-too-quickly-multiplier: 10.0
          timeout-time: 60
          restart-on-crash: true
          restart-script: ./restart.sh
          netty-threads: ${{ github.event.inputs.cpu_cores }}
          attribute:
            maxHealth:
              max: 2048.0
            movementSpeed:
              max: 2048.0
            attackDamage:
              max: 2048.0
        worlds:
          world:
            verbose: true
            spawn-limits:
              monsters: 100
              animals: 20
              water-animals: 10
              water-ambient: 40
              ambient: 30
            entity-activation-range:
              animals: 48
              monsters: 48
              raiders: 64
              misc: 16
              water: 16
              villagers: 32
              flying-monsters: 32
            entity-tracking-range:
              players: 48
              animals: 48
              monsters: 48
              misc: 32
              other: 64
            tick-inactive-villagers: false
            merge-radius:
              item: 4.0
              exp: 6.0
            growth:
              cactus-modifier: 100
              cane-modifier: 100
              melon-modifier: 100
              mushroom-modifier: 100
              pumpkin-modifier: 100
              sapling-modifier: 100
              wheat-modifier: 100
              netherwart-modifier: 100
              vine-modifier: 100
              cocoa-modifier: 100
            entity-merge-radius:
              exp: 3.0
        EOF
        
    - name: Configure Bukkit optimizations
      run: |
        cat > minecraft-server/bukkit.yml << EOF
        settings:
          allow-end: true
          warn-on-overload: true
          permissions-file: permissions.yml
          update-folder: update
          plugin-profiling: false
          connection-throttle: 2000
          query-plugins: true
          deprecated-verbose: default
          shutdown-message: Server closed
          minimum-api: 1.13
          spawn-limits:
            monsters: 100
            animals: 20
            water-animals: 10
            water-ambient: 40
            ambient: 30
          entity-activation-range:
            animals: 48
            monsters: 48
            raiders: 64
            misc: 16
            water: 16
            villagers: 32
            flying-monsters: 32
          chunk-gc:
            period-in-ticks: 600
            load-threshold: 500
          ticks-per:
            animal-spawns: 400
            monster-spawns: 1
            water-spawns: 1
            ambient-spawns: 1
            autosave: 6000
        EOF
        
    - name: Create essential plugins directory
      run: |
        mkdir -p minecraft-server/plugins
        mkdir -p minecraft-server/plugins/EssentialsX
        mkdir -p minecraft-server/plugins/LuckPerms
        mkdir -p minecraft-server/plugins/WorldEdit
        mkdir -p minecraft-server/plugins/Spark
        
        # EssentialsX configuration
        cat > minecraft-server/plugins/EssentialsX/config.yml << EOF
        economy:
          enabled: true
          starting-balance: 1000
          currency-symbol: "$"
          max-money: 1000000
          interest:
            enabled: true
            rate: 0.5
            per: day
            minimum-balance: 1000
        teleport:
          delay: 3
          cooldown: 10
          warmup: 5
          cancel-on-move: true
        homes:
          limit:
            default: 3
            vip: 10
            admin: 20
        spawn:
          set-on-first-join: true
          bed-on-respawn: true
        EOF
        
        # LuckPerms configuration
        cat > minecraft-server/plugins/LuckPerms/config.yml << EOF
        storage-method: yaml
        data:
          save-period: 300
        default-assignments:
          default:
            - group.default
        chat:
          enabled: true
          format: "<{prefix}>{displayname}</{prefix}> {message}"
        permissions:
          debug: false
          allow-op: false
          include-legacy-permissions: true
        EOF
        
    - name: Install system optimization tools
      run: |
        # Update system
        sudo apt-get update
        sudo apt-get upgrade -y
        
        # Install performance monitoring tools
        sudo apt-get install -y htop glances iotop iftop nmon sysstat
        
        # Install Java tools
        sudo apt-get install -y openjdk-21-jdk openjdk-21-jre
        
        # Install network tools
        sudo apt-get install -y net-tools mtr traceroute
        
        # Install compression tools
        sudo apt-get install -y zip unzip pigz
        
        # Install rcon tool
        sudo apt-get install -y mcrcon
        
        # Configure system limits
        cat > /tmp/limits.conf << EOF
        * soft nofile 1048576
        * hard nofile 1048576
        * soft nproc 1048576
        * hard nproc 1048576
        * soft memlock unlimited
        * hard memlock unlimited
        EOF
        sudo cp /tmp/limits.conf /etc/security/limits.d/99-minecraft.conf
        
        # Configure sysctl settings
        cat > /tmp/sysctl.conf << EOF
        # Network optimizations
        net.core.rmem_max=16777216
        net.core.wmem_max=16777216
        net.ipv4.tcp_rmem=4096 87380 16777216
        net.ipv4.tcp_wmem=4096 65536 16777216
        net.ipv4.tcp_syncookies=1
        net.ipv4.tcp_fin_timeout=30
        net.ipv4.tcp_tw_reuse=1
        net.ipv4.tcp_max_syn_backlog=8192
        net.core.somaxconn=32768
        
        # File system optimizations
        vm.swappiness=10
        vm.vfs_cache_pressure=50
        vm.dirty_ratio=15
        vm.dirty_background_ratio=5
        
        # Memory management
        vm.overcommit_memory=1
        EOF
        sudo cp /tmp/sysctl.conf /etc/sysctl.d/99-minecraft.conf
        sudo sysctl -p /etc/sysctl.d/99-minecraft.conf
        
    - name: Set up auto-restart and backup schedule
      run: |
        # Set up hourly backup
        (crontab -l 2>/dev/null; echo "0 * * * * $(pwd)/minecraft-server/backup.sh >> $(pwd)/minecraft-data/logs/backup.log 2>&1") | crontab -
        
        # Set up daily restart at 4 AM
        (crontab -l 2>/dev/null; echo "0 4 * * * $(pwd)/minecraft-server/restart.sh >> $(pwd)/minecraft-data/logs/restart.log 2>&1") | crontab -
        
        # Set up weekly maintenance
        (crontab -l 2>/dev/null; echo "0 3 * * 0 $(pwd)/minecraft-server/backup.sh && $(pwd)/minecraft-server/restart.sh >> $(pwd)/minecraft-data/logs/maintenance.log 2>&1") | crontab -
        
    - name: Create server monitoring script
      run: |
        cat > minecraft-server/monitor.sh << EOF
        #!/bin/bash
        LOG_FILE="$(pwd)/minecraft-data/logs/monitor.log"
        
        while true; do
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
          
          # Check server status
          if pgrep -f paper.jar > /dev/null; then
            SERVER_STATUS="RUNNING"
            PID=$(pgrep -f paper.jar)
            MEM_USAGE=$(ps -p \$PID -o %mem=)
            CPU_USAGE=$(ps -p \$PID -o %cpu=)
            
            # Get TPS using rcon if available
            if command -v mcrcon &> /dev/null; then
              TPS=$(mcrcon -H localhost -P 25575 -p "your_rcon_password" tps | grep -E 'TPS: [0-9.]+' | awk '{print \$2}')
            else
              TPS="N/A"
            fi
            
            echo "[$TIMESTAMP] Server: \$SERVER_STATUS | PID: \$PID | CPU: \$CPU_USAGE% | MEM: \$MEM_USAGE% | TPS: \$TPS" >> \$LOG_FILE
          else
            SERVER_STATUS="STOPPED"
            echo "[$TIMESTAMP] Server: \$SERVER_STATUS - Attempting restart..." >> \$LOG_FILE
            $(pwd)/minecraft-server/restart.sh >> \$LOG_FILE 2>&1
          fi
          
          # Check disk space
          DISK_USAGE=$(df -h $(pwd) | grep -v Filesystem | awk '{print \$5}')
          echo "[$TIMESTAMP] Disk Usage: \$DISK_USAGE" >> \$LOG_FILE
          
          # Check backup directory size
          BACKUP_SIZE=$(du -sh $(pwd)/minecraft-data/backups | awk '{print \$1}')
          echo "[$TIMESTAMP] Backup Size: \$BACKUP_SIZE" >> \$LOG_FILE
          
          # Check for high memory usage
          if (( $(echo "\$MEM_USAGE > 90" | bc -l) )); then
            echo "[$TIMESTAMP] WARNING: High memory usage (\$MEM_USAGE%) - consider restart" >> \$LOG_FILE
          fi
          
          # Check for low TPS
          if [[ "\$TPS" != "N/A" && $(echo "\$TPS < 15" | bc -l) -eq 1 ]]; then
            echo "[$TIMESTAMP] WARNING: Low TPS (\$TPS) - server may be lagging" >> \$LOG_FILE
          fi
          
          sleep 300  # Check every 5 minutes
        done
        EOF
        chmod +x minecraft-server/monitor.sh
        
    - name: Create emergency recovery script
      run: |
        cat > minecraft-server/recover.sh << EOF
        #!/bin/bash
        echo "Starting emergency recovery..."
        
        # Stop any running server
        if pgrep -f paper.jar > /dev/null; then
          echo "Stopping running server..."
          pkill -f paper.jar
          sleep 10
        fi
        
        # Check for corrupt world files
        echo "Checking world integrity..."
        if [ -f minecraft-server/world/level.dat_old ]; then
          echo "Found backup level.dat - restoring..."
          cp minecraft-server/world/level.dat_old minecraft-server/world/level.dat
        fi
        
        # Check plugin directories
        echo "Checking plugin directories..."
        for plugin in minecraft-server/plugins/*; do
          if [ -d "\$plugin" ] && [ ! -f "\$plugin/\$(basename \$plugin).jar" ]; then
            echo "WARNING: Plugin directory \$plugin missing JAR file"
          fi
        done
        
        # Check for available backups
        echo "Available backups:"
        ls -lt minecraft-data/backups/*.zip | head -10
        
        # Ask user if they want to restore from backup
        read -p "Do you want to restore from backup? (y/n): " RESTORE
        if [ "\$RESTORE" = "y" ]; then
          read -p "Enter backup filename: " BACKUP_FILE
          if [ -f "minecraft-data/backups/\$BACKUP_FILE" ]; then
            echo "Restoring from backup: \$BACKUP_FILE"
            unzip -o "minecraft-data/backups/\$BACKUP_FILE" -d minecraft-server/
            echo "Backup restored successfully"
          else
            echo "Backup file not found"
          fi
        fi
        
        # Start server in safe mode
        echo "Starting server in safe mode..."
        cd minecraft-server
        java -Xms1G -Xmx1G -jar paper.jar --safe-mode
        EOF
        chmod +x minecraft-server/recover.sh
        
    - name: Start Minecraft server
      run: |
        cd minecraft-server
        
        # Start monitoring in background
        ./monitor.sh &
        
        # Start server with screen
        screen -dmS minecraft ./start.sh
        
        # Wait for server to start
        echo "Waiting for server to start..."
        for i in {1..30}; do
          if grep -q "Done" logs/latest.log; then
            echo "Server started successfully!"
            break
          fi
          sleep 2
        done
        
        # Check server status
        if screen -list | grep -q "minecraft"; then
          echo "Server is running in screen session"
          echo "To attach: screen -r minecraft"
          echo "To detach: Ctrl+A+D"
        else
          echo "Server failed to start"
          tail -20 logs/latest.log
          exit 1
        fi
        
    - name: Configure firewall
      run: |
        # Install ufw if not present
        sudo apt-get install -y ufw
        
        # Configure firewall rules
        sudo ufw default deny incoming
        sudo ufw default allow outgoing
        sudo ufw allow 25565/tcp
        sudo ufw allow 25565/udp
        sudo ufw allow 22/tcp  # SSH
        sudo ufw allow 80/tcp  # HTTP
        sudo ufw allow 443/tcp # HTTPS
        
        # Enable firewall
        sudo ufw --force enable
        
        # Show status
        sudo ufw status
        
    - name: Create documentation
      run: |
        cat > minecraft-server/README.md << EOF
        # Optimized Minecraft Server Setup
        
        ## Server Information
        - Version: ${{ github.event.inputs.server_version }}
        - Memory: ${{ github.event.inputs.memory_allocation }}
        - CPU Cores: ${{ github.event.inputs.cpu_cores }}
        - Max Players: ${{ github.event.inputs.max_players }}
        - MOTD: ${{ github.event.inputs.server_name }}
        
        ## Directory Structure
        - minecraft-server/ - Server core and configuration
        - minecraft-data/ - World data, backups, logs
        - minecraft-data/backups/ - Automatic backups
        - minecraft-data/logs/ - Server logs
        - minecraft-data/plugins/ - Plugin data
        
        ## Management Commands
        ### Server Control
        - Start: ./start.sh
        - Stop: ./stop.sh or 'stop' in console
        - Restart: ./restart.sh
        - Status: ./status.sh
        
        ### Backup Management
        - Create backup: ./backup.sh
        - List backups: ls -lt ../minecraft-data/backups/
        - Restore backup: ./recover.sh
        
        ### Monitoring
        - Monitor server: ./monitor.sh
        - View logs: tail -f ../minecraft-data/logs/latest.log
        
        ## Performance Optimization
        - JVM: Optimized G1GC settings
        - Paper: Performance-focused configuration
        - Spigot: Entity activation range optimized
        - Bukkit: Chunk garbage collection tuned
        
        ## Security
        - Firewall: UFW configured with minimal ports
        - Whitelist: Enabled by default
        - Online Mode: Enabled for正版验证
        - RCON: Disabled by default
        
        ## Maintenance Schedule
        - Hourly backups: At minute 0 of every hour
        - Daily restart: 4:00 AM
        - Weekly maintenance: Sunday 3:00 AM
        
        ## Emergency Recovery
        If the server fails to start:
        1. Run ./recover.sh
        2. Follow the prompts to restore from backup
        3. Check logs for error messages
        
        ## Plugin Management
        Essential plugins installed:
        - EssentialsX: Core commands and economy
        - LuckPerms: Permission management
        - WorldEdit: World editing tools
        - Spark: Performance monitoring
        
        To install new plugins:
        1. Download .jar file to plugins/ directory
        2. Restart server: ./restart.sh
        3. Configure plugin in plugins/[PluginName]/config.yml
        
        ## Support
        For issues, check:
        - Server logs: ../minecraft-data/logs/latest.log
        - Monitor logs: ../minecraft-data/logs/monitor.log
        - Backup logs: ../minecraft-data/logs/backup.log
        EOF
        
    - name: Final setup verification
      run: |
        echo "=== Server Setup Verification ==="
        echo "Server version: ${{ github.event.inputs.server_version }}"
        echo "Memory allocation: ${{ github.event.inputs.memory_allocation }}"
        echo "CPU cores: ${{ github.event.inputs.cpu_cores }}"
        echo "Max players: ${{ github.event.inputs.max_players }}"
        echo "=================================="
        
        # Check critical files
        echo "Checking critical files..."
        CRITICAL_FILES=(
          "minecraft-server/paper.jar"
          "minecraft-server/server.properties"
          "minecraft-server/eula.txt"
          "minecraft-server/start.sh"
          "minecraft-server/restart.sh"
          "minecraft-server/backup.sh"
        )
        
        for file in "\${CRITICAL_FILES[@]}"; do
          if [ -f "\$file" ]; then
            echo "✓ \$file exists"
          else
            echo "✗ \$file missing"
            exit 1
          fi
        done
        
        # Check directory permissions
        echo "Checking directory permissions..."
        chmod -R 755 minecraft-server/
        chmod -R 755 minecraft-data/
        
        echo "Setup completed successfully!"
        echo "Server is ready to start"
        echo "Use './start.sh' to start the server"
        echo "Use 'screen -r minecraft' to attach to the server console"