name: Redroid-WebScreen-RK Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Initialize Redroid environment
      run: |
        sudo mkdir -p /dev/binderfs
        if ! mountpoint -q /dev/binderfs; then
          sudo mount -t binder binder /dev/binderfs
        fi
        sudo chmod 666 /dev/binderfs/binder
        sudo chmod 666 /dev/binderfs/hwbinder
        sudo chmod 666 /dev/binderfs/vndbinder
        
        if [ -e /dev/dma_heap/reserved ]; then
          sudo chmod 666 /dev/dma_heap/reserved
          sudo rm -f /dev/dma_heap/linux,cma
          sudo ln -s reserved /dev/dma_heap/linux,cma
          sudo rm -f /dev/dma_heap/system-uncached-dma32
          sudo ln -s system-uncached /dev/dma_heap/system-uncached-dma32
          sudo chmod 666 /dev/dma_heap/*
        fi
        
    - name: Create data directory
      run: mkdir -p data
      
    - name: Deploy with Docker Compose
      run: |
        docker compose up -d
        
    - name: Verify deployment
      run: |
        docker ps
        sleep 30
        docker logs redroid
        docker logs webscreen
        
    - name: Set up permanent storage
      uses: actions/cache@v4
      with:
        path: ./data
        key: ${{ runner.os }}-redroid-data-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-redroid-data-
          
    - name: Health check
      run: |
        curl --retry 10 --retry-delay 5 http://localhost:8079 || echo "WebScreen not ready yet"
        
    - name: Save deployment info
      run: |
        echo "Deployment completed at: $(date)" > deployment_info.txt
        echo "Redroid container ID: $(docker inspect -f '{{.Id}}' redroid)" >> deployment_info.txt
        echo "WebScreen container ID: $(docker inspect -f '{{.Id}}' webscreen)" >> deployment_info.txt
        
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: deployment_info.txt
        
    - name: Restart workflow after completion
      run: |
        echo "Workflow completed. Next run scheduled."
