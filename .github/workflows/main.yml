name: Windows RDP with EXE Execution and Persistent Storage

on:
  workflow_dispatch:
    inputs:
      rdp_password:
        description: 'Remote Desktop Password (min 8 chars, must include uppercase, lowercase, number, and special character)'
        required: true
        type: string
      rdp_port:
        description: 'Remote Desktop Port (default: 3389)'
        required: false
        default: '3389'
        type: string
      exe_url:
        description: 'URL of EXE file to download and run (optional)'
        required: false
        default: ''
        type: string
      storage_repo:
        description: 'GitHub repository for persistent storage (format: username/repo)'
        required: false
        default: ''
        type: string
      storage_token:
        description: 'GitHub Personal Access Token with repo scope (for storage)'
        required: false
        default: ''
        type: string

jobs:
  windows-rdp:
    runs-on: windows-2022
    timeout-minutes: 360  # 6Â∞èÊó∂Ë∂ÖÊó∂ÔºàÂèØÊ†πÊçÆÈúÄË¶ÅË∞ÉÊï¥Ôºâ
    
    steps:
      - name: üö® Important Disclaimer
        run: |
          Write-Host "============================================="
          Write-Host "‚ö†Ô∏è  IMPORTANT: FOR LEARNING PURPOSES ONLY"
          Write-Host "============================================="
          Write-Host "This workflow is provided solely for educational"
          Write-Host "and learning purposes. Users are responsible for"
          Write-Host "complying with GitHub's Terms of Service and"
          Write-Host "all applicable laws and regulations."
          Write-Host "============================================="
        error-action: continue

      - name: üìã Validate Input Parameters
        run: |
          Write-Host "============================================="
          Write-Host "Validating Input Parameters"
          Write-Host "============================================="
          
          # Validate password complexity
          $rdpPassword = "${{ inputs.rdp_password }}"
          $passwordRequirements = @(
              @{ Name = "Minimum length 8 characters"; Test = { $rdpPassword.Length -ge 8 } },
              @{ Name = "At least one uppercase letter"; Test = { $rdpPassword -match '[A-Z]' } },
              @{ Name = "At least one lowercase letter"; Test = { $rdpPassword -match '[a-z]' } },
              @{ Name = "At least one number"; Test = { $rdpPassword -match '[0-9]' } },
              @{ Name = "At least one special character"; Test = { $rdpPassword -match '[^a-zA-Z0-9]' } }
          )
          
          $valid = $true
          foreach ($req in $passwordRequirements) {
              if (-not & $req.Test) {
                  Write-Error "‚ùå Password validation failed: $($req.Name)"
                  $valid = $false
              } else {
                  Write-Host "‚úÖ $($req.Name)"
              }
          }
          
          if (-not $valid) {
              Write-Error "‚ùå Password does not meet complexity requirements"
              exit 1
          }
          
          # Validate port number
          $rdpPort = "${{ inputs.rdp_port }}"
          if (-not ($rdpPort -match '^\d+$') -or $rdpPort -lt 1 -or $rdpPort -gt 65535) {
              Write-Error "‚ùå Invalid port number: $rdpPort"
              exit 1
          }
          
          Write-Host "`n‚úÖ All parameters validated successfully"
        error-action: stop

      - name: üñ•Ô∏è Configure Remote Desktop Access
        run: |
          Write-Host "============================================="
          Write-Host "Configuring Remote Desktop Access"
          Write-Host "============================================="
          
          try {
              # Set RDP password from input
              $rdpPassword = "${{ inputs.rdp_password }}"
              $env:COMPUTERNAME = $env:COMPUTERNAME.ToUpper()
              $userName = "GitHubActionsUser"
              $rdpPort = "${{ inputs.rdp_port }}"
              
              Write-Host "`nCreating RDP user account: $userName"
              
              # Check if user already exists
              if (-not (Get-LocalUser -Name $userName -ErrorAction SilentlyContinue)) {
                  # Create new user with proper error handling
                  $securePassword = ConvertTo-SecureString $rdpPassword -AsPlainText -Force
                  New-LocalUser -Name $userName -Password $securePassword `
                                -FullName "GitHub Actions User" `
                                -Description "User for RDP access (learning purposes only)" `
                                -ErrorAction Stop
                  
                  # Add user to Remote Desktop Users group
                  Add-LocalGroupMember -Group "Remote Desktop Users" -Member $userName -ErrorAction Stop
                  Write-Host "‚úÖ User $userName added to Remote Desktop Users group"
              } else {
                  Write-Host "‚ÑπÔ∏è  User $userName already exists, updating password"
